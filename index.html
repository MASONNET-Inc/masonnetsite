<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>MASONNET Web 3.0</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#ff0000;
      --accent:#ffffff;
      --glass: rgba(255,255,255,0.06);
      --safe-bottom: calc(env(safe-area-inset-bottom, 0px) + 16px);
      --island-max:920px;
      --tooltip-bg: rgba(0,0,0,0.88);
      --tooltip-color: #fff;
      --focus: rgba(255,255,255,0.12);
      --muted: rgba(255,255,255,0.9);
      --panel-bg: #121212;
      --card-bg: rgba(255,255,255,0.03);
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,Helvetica,sans-serif;-webkit-font-smoothing:antialiased}
    body{background:var(--bg);color:var(--accent);display:flex;align-items:center;justify-content:center;padding:28px}

    /* Gate */
    .gate {
      width:100%;
      max-width:1100px;
      background: linear-gradient(180deg, rgba(0,0,0,0.06), rgba(0,0,0,0.02));
      border-radius:14px;
      padding:28px;
      text-align:center;
      box-shadow: 0 8px 30px rgba(0,0,0,0.35);
    }
    img.logo { width: clamp(160px, 24vw, 360px); height:auto; display:block; margin:0 auto 12px; }
    h2 { margin:6px 0 8px; font-weight:600; font-size:20px; color:#fff; }
    p.lead { margin:0 0 16px; color:var(--muted) }
    .pwrow { display:flex; gap:10px; justify-content:center; align-items:center; margin-top:14px; flex-wrap:wrap }
    .pwrow input[type="password"]{ padding:12px 14px;border-radius:10px;border:0;min-width:260px;background:var(--card-bg);color:var(--accent);font-size:15px; }
    .pwrow button{ padding:12px 14px;border-radius:10px;border:0;background:#111;color:#fff;cursor:pointer;font-weight:700 }
    .err{ color:#ffd3d3; min-height:20px; margin-top:10px }
    #protected{ display:none; width:100%; max-width:1200px; }

    /* Protected layout */
    .page{ padding: clamp(14px, 3.5vw, 36px); padding-bottom: calc(var(--safe-bottom) + 160px); text-align:center; margin:0 auto; }
    h1{ margin:6px 0 10px; font-size: clamp(20px, 4.2vw, 34px); font-weight:700; color:#fff; }
    hr.fancy{ border:0; height:1px; margin:10px auto 0; width:100%; max-width:980px; background:linear-gradient(90deg, rgba(255,255,255,0.04), rgba(255,255,255,0.12), rgba(255,255,255,0.04)); border-radius:1px; }

    /* Button island */
    .button-island {
      position: fixed; left:50%; transform: translateX(-50%); bottom: var(--safe-bottom); z-index:1200;
      display:flex; gap:12px; padding:12px; align-items:center; justify-content:space-between;
      width: min(calc(100% - 32px), var(--island-max)); background: var(--glass); border-radius:999px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.28); backdrop-filter: blur(6px);
    }
    .btn{ all:unset; position:relative; display:inline-flex; align-items:center; justify-content:center; gap:10px; padding:10px 14px; border-radius:10px; cursor:pointer; color:var(--accent); background:transparent; min-width:54px }
    .btn.primary{ background: rgba(255,255,255,0.04); padding:10px 16px; font-weight:700; border-radius:12px; }
    .btn:focus{ outline:3px solid var(--focus); outline-offset:3px; border-radius:10px }
    .icon{ width:28px; height:28px; display:inline-block; vertical-align:middle; fill:currentColor; color:#fff; opacity:0.98 }
    .label{ font-size:13px; color:var(--muted) }

    /* Info button */
    .info-btn{ width:52px; height:52px; display:inline-grid; place-items:center; border-radius:12px; background:var(--card-bg); cursor:pointer }
    .info-panel{ position: fixed; right:16px; bottom: calc(var(--safe-bottom) + 80px); z-index:1250; width: clamp(180px, 20vw, 320px); background: var(--panel-bg); color:#fff; padding:12px; border-radius:10px; display:none; box-shadow: 0 10px 30px rgba(0,0,0,0.45) }
    .info-panel.visible{ display:block }
    .version-pill{ background: rgba(255,255,255,0.03); padding:6px 10px; border-radius:999px; font-weight:700; font-size:13px; display:inline-block }
    .panel-view{ display:inline-flex; gap:10px; align-items:center; padding:8px 12px; border-radius:999px; background: rgba(255,255,255,0.02); font-weight:700; font-size:14px; margin-top:10px }
    .panel-view .icon{ width:20px; height:20px }

    /* Tooltips */
    [data-tooltip]{ position:relative; }
    [data-tooltip]:hover::after,[data-tooltip]:focus::after{
      content: attr(data-tooltip); position:absolute; left:50%; transform:translateX(-50%); bottom: calc(100% + 10px); background:var(--tooltip-bg); color:var(--tooltip-color); padding:6px 8px; border-radius:8px; font-size:13px; white-space:nowrap; z-index:1300; box-shadow: 0 10px 30px rgba(0,0,0,0.45);
    }
    [data-tooltip]:hover::before,[data-tooltip]:focus::before{
      content:""; position:absolute; left:50%; transform:translateX(-50%) rotate(45deg); bottom: calc(100% + 2px); width:10px; height:10px; background:var(--tooltip-bg); z-index:1300;
    }

    /* Misc */
    @media (max-width:520px) {
      .icon{ width:24px; height:24px }
      .info-btn{ width:48px; height:48px }
      .button-island{ padding:10px; gap:8px }
    }
  </style>
</head>
<body>
  <!-- Locked splash -->
  <div id="gate" class="gate" role="main" aria-live="polite">
    <img src="logo.png" alt="MASONNET logo" class="logo" />
    <h2>MASONNET Web 3 is under development. Check back soon!</h2>
    <p class="lead">Enter the password to continue to the site.</p>

    <div class="pwrow">
      <input id="pw" type="password" aria-label="Password" autocomplete="current-password" />
      <button id="enterBtn" class="primary" aria-label="Enter password">Enter</button>
    </div>
    <div id="err" class="err" role="status" aria-live="polite"></div>
    <p style="font-size:13px;color:var(--muted);margin-top:10px">Password is stored securely on the server and not in this file.</p>
  </div>

  <!-- Protected UI -->
  <div id="protected">
    <div class="page">
      <header style="padding-top:6px">
        <img src="logo.png" alt="MASONNET logo" class="logo" />
        <h1>Welcome to MASONNET Web <u>3.0</u>!</h1>
        <hr class="fancy" />
      </header>

      <main role="main" aria-labelledby="mainTitle">
        <section id="mainContent" style="padding:18px 0;max-width:980px;margin:0 auto;text-align:left">
          <!-- Full richer UI (paste/extend here) -->
          <div style="background:var(--card-bg); padding:18px; border-radius:12px; color:var(--muted)">
            <h3 style="color:#fff;margin:0 0 8px">Project status</h3>
            <p style="margin:0 0 8px">This site is under active development. Features are being added and iterated.</p>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
              <a class="label" href="#" style="text-decoration:underline;color:var(--muted)">Docs</a>
              <a class="label" href="#" style="text-decoration:underline;color:var(--muted)">Roadmap</a>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- Info panel -->
    <div id="infoPanel" class="info-panel" role="dialog" aria-hidden="true" tabindex="-1">
      <div style="display:flex;flex-direction:column;align-items:center;gap:8px">
        <div class="version-pill">Version 1.0 — In development</div>
        <div style="font-size:13px;color:var(--muted)">by Mason Murphy & MASONNET</div>
        <div class="panel-view" aria-hidden="false">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M12 8.5a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7z" fill="currentColor"/>
            <path d="M2.8 12s3.1-5.2 9.2-5.2S21.2 12 21.2 12 18.1 17.2 12 17.2 2.8 12 2.8 12z" fill="none" stroke="currentColor" stroke-width="1.05" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span id="viewsLabel">Views: —</span>
        </div>
        <a href="mailto:masonnet@masonnet.org" style="color:var(--muted); text-decoration:underline; font-size:13px; margin-top:8px">Contact Us</a>
      </div>
    </div>

    <!-- Button island -->
    <nav class="button-island" role="navigation" aria-label="Primary navigation">
      <div style="display:flex;align-items:center;gap:8px;">
        <button class="btn" data-tooltip="Home" aria-label="Home" title="Home">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M3 11.5L12 4l9 7.5V20a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1V11.5z" fill="currentColor"/></svg>
        </button>

        <button class="btn" data-tooltip="Games" aria-label="Games" title="Games">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 10a4 4 0 0 0-4 4v1a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3v-1a4 4 0 0 0-4-4H6z" fill="currentColor"/><path d="M9.2 13.8h1.8M10.1 12.1v1.8M14.6 13.8h1.8M15.5 12.1v1.8" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" transform="translate(-0.6,-0.2)"/></svg>
        </button>

        <button class="btn" data-tooltip="Projects" aria-label="Projects" title="Projects">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M3 7a2 2 0 0 1 2-2h4l2 2h6a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z" fill="currentColor"/></svg>
        </button>

        <button class="btn" data-tooltip="More" aria-label="More" title="More">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><circle cx="5.5" cy="12" r="1.95" fill="currentColor"/><circle cx="12" cy="12" r="1.95" fill="currentColor"/><circle cx="18.5" cy="12" r="1.95" fill="currentColor"/></svg>
        </button>
      </div>

      <div style="display:flex;align-items:center;gap:8px;">
        <button id="infoBtn" class="info-btn" data-tooltip="Info" aria-label="Info" aria-expanded="false" title="Info">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <circle cx="12" cy="12" r="9.3" fill="none" stroke="currentColor" stroke-width="1.15"/>
            <circle cx="12" cy="8.3" r="1.05" fill="currentColor"/>
            <rect x="11.05" y="10.6" width="1.9" height="5.0" rx="0.55" fill="currentColor"/>
          </svg>
        </button>

        <button id="logoutBtn" class="btn" data-tooltip="Logout" aria-label="Logout" title="Logout">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M16 13v-2H7V8l-5 4 5 4v-3zM20 3h-8v2h8v14h-8v2h8a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z" fill="currentColor"/></svg>
        </button>
      </div>
    </nav>
  </div>

  <script>
    (function(){
      const endpoint = '/.netlify/functions/auth';
      const gate = document.getElementById('gate');
      const protectedNode = document.getElementById('protected');
      const enterBtn = document.getElementById('enterBtn');
      const pwInput = document.getElementById('pw');
      const errEl = document.getElementById('err');
      const infoBtn = document.getElementById('infoBtn');
      const infoPanel = document.getElementById('infoPanel');
      const logoutBtn = document.getElementById('logoutBtn');
      const viewsLabel = document.getElementById('viewsLabel');

      function hasSessionCookie() {
        return document.cookie.split(';').some(c => c.trim().startsWith('masonnet_session='));
      }

      function showProtected() {
        gate.style.display = 'none';
        protectedNode.style.display = 'block';
      }

      if (hasSessionCookie()) showProtected();

      async function tryLogin(password) {
        errEl.textContent = '';
        try {
          const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password })
          });

          if (res.ok) {
            location.reload();
            return;
          }

          const j = await res.json().catch(()=>({}));
          errEl.textContent = j && j.error ? 'Incorrect password' : 'Login failed';
        } catch (e) {
          errEl.textContent = 'Network error';
        }
      }

      enterBtn.addEventListener('click', ()=> tryLogin(pwInput.value));
      pwInput.addEventListener('keydown', (e)=> { if (e.key === 'Enter') tryLogin(pwInput.value); });

      // Info panel toggle
      let lastFocus = null;
      function toggleInfo(force) {
        const show = typeof force === 'boolean' ? force : !infoPanel.classList.contains('visible');
        if (show) {
          lastFocus = document.activeElement;
          infoPanel.classList.add('visible');
          infoPanel.setAttribute('aria-hidden','false');
          infoBtn.setAttribute('aria-expanded','true');
          try { infoPanel.focus({preventScroll:true}); } catch(e){}
        } else {
          infoPanel.classList.remove('visible');
          infoPanel.setAttribute('aria-hidden','true');
          infoBtn.setAttribute('aria-expanded','false');
          try { if (lastFocus) lastFocus.focus(); } catch(e){}
        }
      }
      infoBtn.addEventListener('click', ()=> toggleInfo());
      infoBtn.addEventListener('keydown', (e)=> { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleInfo(); } });
      document.addEventListener('click', (e)=> {
        if (!infoPanel.classList.contains('visible')) return;
        if (infoPanel.contains(e.target) || infoBtn.contains(e.target)) return;
        toggleInfo(false);
      }, {capture:true});
      document.addEventListener('keydown', (e)=> { if (e.key === 'Escape') toggleInfo(false); });

      // Logout (server-side route recommended)
      logoutBtn.addEventListener('click', async ()=> {
        // If you add a Netlify logout function that clears cookie, call it here.
        // For now reload to clear client state; server cookie expiry controls actual session.
        location.reload();
      });

      // View counter using CountAPI with recent-visit suppression
      (function viewCounter(){
        const localVisitKey = 'masonnet_org_lastvisit';
        const storedCountKey = 'masonnet_org_localcount';
        const countNamespace = 'masonnet_org';
        const countKey = 'site_views';
        const hitUrl = `https://api.countapi.xyz/hit/${encodeURIComponent(countNamespace)}/${encodeURIComponent(countKey)}`;
        const getUrl = `https://api.countapi.xyz/get/${encodeURIComponent(countNamespace)}/${encodeURIComponent(countKey)}`;
        const threshold = 60*60*1000; // 1 hour

        function setViews(v){ if (viewsLabel) viewsLabel.textContent = 'Views: ' + (typeof v === 'number' ? v.toLocaleString() : String(v)); }
        function safeSetLocal(k,v){ try { localStorage.setItem(k,String(v)); } catch(e){} }
        function safeGetLocal(k){ try { return localStorage.getItem(k); } catch(e){ return null } }

        const lastVisit = parseInt(safeGetLocal(localVisitKey) || '0',10);
        const now = Date.now();
        const within = !isNaN(lastVisit) && (now - lastVisit) < threshold;

        if (within) {
          fetch(getUrl, {cache:'no-store'}).then(r=>r.ok? r.json():Promise.reject(r)).then(data=>{
            if (data && typeof data.value === 'number') { setViews(data.value); safeSetLocal(storedCountKey, data.value); }
            else { const v = parseInt(safeGetLocal(storedCountKey) || '0',10); setViews(isNaN(v)?'—':v); }
          }).catch(()=> { const v = parseInt(safeGetLocal(storedCountKey) || '0',10); setViews(isNaN(v)?'—':v); });
        } else {
          fetch(hitUrl, {method:'GET', cache:'no-store'}).then(r=>r.ok? r.json():Promise.reject(r)).then(data=>{
            if (data && typeof data.value === 'number') { setViews(data.value); safeSetLocal(storedCountKey, data.value); safeSetLocal(localVisitKey, now); }
            else { throw new Error('invalid'); }
          }).catch(()=> {
            fetch(getUrl, {cache:'no-store'}).then(r=>r.ok? r.json():Promise.reject(r)).then(data=>{
              if (data && typeof data.value === 'number') { setViews(data.value); safeSetLocal(storedCountKey, data.value); safeSetLocal(localVisitKey, now); }
              else { throw new Error('invalidget'); }
            }).catch(()=> {
              try { let v = parseInt(safeGetLocal(storedCountKey) || '0',10); v = isNaN(v) ? 1 : v + 1; safeSetLocal(storedCountKey, v); safeSetLocal(localVisitKey, now); setViews(v); } catch(e){ setViews('—') }
            });
          });
        }
      })();

      // Make interactive controls keyboard accessible
      document.querySelectorAll('.btn, .info-btn').forEach(b => { b.tabIndex = 0; });

    })();
  </script>
</body>
</html>
